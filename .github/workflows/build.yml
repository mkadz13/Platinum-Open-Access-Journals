name: Build journal list site

on:
  push:
    paths:
      - "scripts/**"
      - "data/**"
      - ".github/workflows/**"
      - "requirements.txt"
  schedule:
    - cron: "0 9 1 3 *" 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download latest DOAJ journal CSV
        run: |
          mkdir -p data
          curl -L -o data/doaj.csv "https://doaj.org/csv"

      - name: Select newest JIF file
        id: pickjif
        run: |
          # expects files named like data/JIF2021.csv, data/JIF2023.csv
          newest="$(ls data/JIF*.csv | sed -E 's/.*JIF([0-9]{4}).csv/\1 \0/' | sort -nr | head -n1 | awk '{print $2}')"
          year="$(echo "$newest" | sed -E 's/.*JIF([0-9]{4}).csv/\1/')"
          echo "jif_path=$newest" >> "$GITHUB_OUTPUT"
          echo "year=$year" >> "$GITHUB_OUTPUT"
          echo "Using $newest (year=$year)"

      - name: Build docs/index.html
        run: |
          python scripts/JifMatch.py \
            --doaj data/doaj.csv \
            --jif "${{ steps.pickjif.outputs.jif_path }}" \
            --label "${{ steps.pickjif.outputs.year }}" \
            --out docs/index.html

      - name: Commit updated site (and DOAJ snapshot)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/doaj.csv data/doaj_diamond_active.csv data/doaj_issns.txt docs/index.html
          git commit -m "Update DOAJ + rebuild site" || echo "No changes to commit"
          git push
